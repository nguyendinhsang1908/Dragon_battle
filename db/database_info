CREATE TABLE Messages (
    id INT AUTO_INCREMENT PRIMARY KEY,
    sender_id INT NOT NULL,                -- ID người gửi
    receiver_id INT DEFAULT NULL,          -- ID người nhận (Friend chat)
    clan_id INT DEFAULT NULL,              -- ID clan (Clan chat)
    team_id INT DEFAULT NULL,              -- ID team (Team chat)
    message_type ENUM('world', 'clan', 'friend', 'team') NOT NULL, -- Loại chat
    message TEXT NOT NULL,                 -- Nội dung tin nhắn
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP -- Thời gian gửi
);


CREATE TABLE Users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    clan_id INT DEFAULT NULL,             -- ID Clan của người dùng
    team_id INT DEFAULT NULL,             -- ID Team của người dùng
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE Clans (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    Own VARCHAR(25) NOT NULL UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


CREATE TABLE Teams (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


CREATE TABLE Messages (
    id INT AUTO_INCREMENT PRIMARY KEY,
    sender_id INT NOT NULL,                -- ID người gửi
    receiver_id INT DEFAULT NULL,          -- ID người nhận (Friend chat)
    clan_id INT DEFAULT NULL,              -- ID clan (Clan chat)
    team_id INT DEFAULT NULL,              -- ID team (Team chat)
    message_type ENUM('world', 'clan', 'friend', 'team') NOT NULL, -- Loại chat
    message TEXT NOT NULL,                 -- Nội dung tin nhắn
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP -- Thời gian gửi
);

CREATE TABLE Items (
    ItemID INT AUTO_INCREMENT PRIMARY KEY,
    Name VARCHAR(255)  NOT NULL UNIQUE,
    IsStackable BOOLEAN DEFAULT FALSE, -- Vật phẩm có thể xếp chồng không
    MaxStack INT DEFAULT 1             -- Số lượng tối đa có thể xếp chồng
);

CREATE TABLE Inventory (
    InventoryID INT AUTO_INCREMENT PRIMARY KEY,
    PlayerID INT NOT NULL,             -- Người chơi sở hữu inventory
    ItemID INT NOT NULL,               -- ID vật phẩm
    Quantity INT NOT NULL DEFAULT 1,   -- Số lượng
    FOREIGN KEY (ItemID) REFERENCES Items(ItemID),
    UNIQUE (PlayerID, ItemID)          -- Đảm bảo mỗi vật phẩm chỉ xuất hiện 1 lần cho mỗi người chơi
);

CREATE TABLE Dragons (
    ID INT AUTO_INCREMENT PRIMARY KEY,
    Name VARCHAR(255) NOT NULL UNIQUE,
    Point INT,
    Hp INT,
    Mp INT,
    Dame INT,
    Defense INT,
    Speed INT,
    Rarity VARCHAR(50),
    Element VARCHAR(50)
);

---STRIGGER----

-- Check Insert,Update item
-- if IsStackable = false => Maxstack = 1 
DELIMITER $$

CREATE TRIGGER before_item_insert
BEFORE INSERT ON Items
FOR EACH ROW
BEGIN
    IF NEW.IsStackable = FALSE AND NEW.MaxStack != 1 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Nếu IsStackable là false, MaxStack phải bằng 1';
    END IF;
END $$

DELIMITER ;


DELIMITER $$

CREATE TRIGGER before_item_update
BEFORE UPDATE ON Items
FOR EACH ROW
BEGIN
    IF NEW.IsStackable = FALSE AND NEW.MaxStack != 1 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Nếu IsStackable là false, MaxStack phải bằng 1';
    END IF;
END $$

DELIMITER ;
